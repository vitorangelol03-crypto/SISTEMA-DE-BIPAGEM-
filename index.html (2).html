<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bipagem">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNpc3RlbWEgZGUgQmlwYWdlbSIsCiAgInNob3J0X25hbWUiOiAiQmlwYWdlbSIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiM0Q0FGNTAiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhPVElpSUdobGFXZG9kRDBpTVRreUlqNDhjbVZqZENCM2FXUjBhRDBpTVRreUlpQm9aV2xuYUhROUlqRTVNaUlnWm1sc2JEMGlJelJEUVVZMU1DSXZQangwWlhoMElIZzlJalEwSWlCNVBTSTVOaUlnWm05dWRDMW1ZVzFwYkhrOUlrRnlhV0ZzSWlCbWIyNTBMWE5wZW1VOUlqUTRJaUJtYVd4c1BTSWpabVptSWlCMFpYaDBMV0Z1WTJodmNqMGliV2xrWkd4bElqNUNTVkE4TDNSbGVIUStQQzl6ZG1jKyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhkcFpIUm9QU0kxTVRJaUlHaGxhV2RvZEQwaU5URXlJajQ4Y21WamRDQjNhV1IwYUQwaU5URXlJaUJvWldsbmFIUTlJalV4TWlJZ1ptbHNiRDBpSXpSRFFVWTFNQ0l2UGp4MFpYaDBJSGc5SWpFd05DSWdlVDBpTWpVMklpQm1iMjUwTFdaaGJXbHNlVDBpUVhKcFlXd2lJR1p2Ym5RdGMybDZaVDBpT1RZaUlHWnBiR3c5SWlObVptWWlJSFJsZUhRdFlXNWphRzl5UFNKdGFXUmtiR1VpUGtKSlVEd3ZkR1Y0ZEQ0OEwzTjJaejQ9IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIj48cmVjdCB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgZmlsbD0iIzRDQUY1MCIvPjx0ZXh0IHg9IjQ0IiB5PSI5NiIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjQ4IiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5CSVA8L3RleHQ+PC9zdmc+">
    <title>Sistema de Bipagem</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        button {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background: #45a049;
        }

        button:active {
            transform: scale(0.98);
        }

        .scan-area {
            display: none;
        }

        .info-box {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }

        .info-box p {
            margin: 5px 0;
            color: #2e7d32;
        }

        .scan-input {
            background: #f9f9f9;
            border: 2px dashed #4CAF50;
        }

        .codes-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 20px 0;
            background: #fafafa;
        }

        .code-item {
            padding: 12px;
            margin: 8px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .code-item.duplicate {
            background: #ffebee;
            border-left-color: #f44336;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .code-item.invalid {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .code-text {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
        }

        .duplicate .code-text {
            color: #f44336;
        }

        .invalid .code-text {
            color: #ff9800;
        }

        .time-text {
            font-size: 12px;
            color: #888;
        }

        .download-buttons {
            display: flex;
            gap: 10px;
        }

        .download-buttons button {
            flex: 1;
        }

        .btn-secondary {
            background: #2196F3;
        }

        .btn-secondary:hover {
            background: #1976D2;
        }

        .btn-remove {
            background: #ff9800;
            margin-top: 10px;
        }

        .btn-remove:hover {
            background: #f57c00;
        }

        .hidden {
            display: none;
        }

        .alert-overlay, .remove-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .alert-box, .remove-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }

        .alert-box.error {
            border-top: 5px solid #f44336;
        }

        .remove-box {
            border-top: 5px solid #ff9800;
        }

        .remove-box h2 {
            color: #ff9800;
            margin-bottom: 15px;
        }

        .remove-box input {
            margin-bottom: 20px;
        }

        .motivo-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .motivo-buttons button {
            margin: 0;
            background: #ff9800;
        }

        .motivo-buttons button:hover {
            background: #f57c00;
        }

        .btn-cancel {
            background: #f44336 !important;
        }

        .btn-cancel:hover {
            background: #d32f2f !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tela Inicial -->
        <div id="initialScreen">
            <h1>Sistema de Bipagem</h1>
            <div class="form-group">
                <label>Nome do Operador:</label>
                <input type="text" id="operatorName" placeholder="Digite seu nome">
            </div>
            <div class="form-group">
                <label>Nome da Rota:</label>
                <input type="text" id="routeName" placeholder="Digite o nome da rota">
            </div>
            <div class="form-group">
                <label>Data:</label>
                <input type="text" id="currentDate" readonly>
            </div>
            <button onclick="startScanning()">Iniciar Bipagem</button>
        </div>

        <!-- Tela de Bipagem -->
        <div id="scanScreen" class="scan-area">
            <h1>Bipagem de Códigos</h1>
            <div class="info-box">
                <p><strong>Operador:</strong> <span id="displayOperator"></span></p>
                <p><strong>Rota:</strong> <span id="displayRoute"></span></p>
                <p><strong>Data:</strong> <span id="displayDate"></span></p>
            </div>

            <div class="form-group">
                <label>Bipe o código:</label>
                <input type="text" id="codeInput" class="scan-input" placeholder="Aguardando leitura..." autocomplete="off">
            </div>

            <div class="codes-list" id="codesList"></div>

            <div class="download-buttons">
                <button onclick="downloadTXT()">Baixar TXT</button>
                <button onclick="downloadCSV()" class="btn-secondary">Baixar CSV</button>
            </div>
            
            <button onclick="openRemoveOverlay()" class="btn-remove">Remover Código</button>
            <button onclick="clearSession()" style="background: #f44336; margin-top: 10px;">Limpar Sessão e Reiniciar</button>
        </div>
    </div>

    <!-- Alert Overlay (existente) -->
    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-box error">
            <h2>⚠️ ATENÇÃO!</h2>
            <p id="alertMessage"></p>
            <button onclick="closeAlert()">OK</button>
        </div>
    </div>

    <!-- Remove Overlay (novo) -->
    <div class="remove-overlay" id="removeOverlay">
        <div class="remove-box">
            <h2>Remover Código</h2>
            <input type="text" id="removeCodeInput" placeholder="Digite ou bipe o código" autocomplete="off">
            <div class="motivo-buttons">
                <button onclick="processRemove('Pacote vazio')">Pacote vazio</button>
                <button onclick="processRemove('Pacote Avariado')">Pacote Avariado</button>
                <button onclick="processRemove('Rota errada')">Rota errada</button>
                <button onclick="closeRemoveOverlay()" class="btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', (e) => {
                        e.waitUntil(
                            caches.open('bipagem-v1').then((cache) => {
                                return cache.addAll(['/']);
                            })
                        );
                    });
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(
                            caches.match(e.request).then((response) => {
                                return response || fetch(e.request);
                            })
                        );
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl);
            });
        }

        let scannedCodes = [];
        let removedCodes = []; // Novo array para códigos removidos
        let operatorName = '';
        let routeName = '';
        let currentDate = '';
        let audioContext;
        let validCodes = new Set();

        // Carregar dados salvos ao abrir o app
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('bipagem_session');
            if (savedData) {
                const data = JSON.parse(savedData);
                // Verificar se é a mesma sessão (mesmo dia)
                const today = new Date().toLocaleDateString('pt-BR');
                if (data.date === today && data.operator && data.route) {
                    // Perguntar se quer continuar
                    if (confirm(`Continuar sessão de ${data.operator} na rota ${data.route}?`)) {
                        operatorName = data.operator;
                        routeName = data.route;
                        currentDate = data.date;
                        scannedCodes = data.codes || [];
                        removedCodes = data.removedCodes || []; // Restaurar removidos
                        validCodes = new Set(data.validCodes || []);
                        
                        // Ir direto para tela de bipagem
                        document.getElementById('initialScreen').style.display = 'none';
                        document.getElementById('scanScreen').style.display = 'block';
                        document.getElementById('displayOperator').textContent = operatorName;
                        document.getElementById('displayRoute').textContent = routeName;
                        document.getElementById('displayDate').textContent = currentDate;
                        
                        // Recarregar lista
                        refreshCodesList();
                        document.getElementById('codeInput').focus();
                        return;
                    } else {
                        localStorage.removeItem('bipagem_session');
                    }
                }
            }
        });

        // Salvar dados automaticamente
        function saveSession() {
            const sessionData = {
                operator: operatorName,
                route: routeName,
                date: currentDate,
                codes: scannedCodes,
                removedCodes: removedCodes, // Salvar removidos
                validCodes: Array.from(validCodes)
            };
            localStorage.setItem('bipagem_session', JSON.stringify(sessionData));
        }

        // Inicializar data atual
        window.onload = function() {
            const today = new Date();
            const dateStr = today.toLocaleDateString('pt-BR');
            document.getElementById('currentDate').value = dateStr;
        };

        function startScanning() {
            operatorName = document.getElementById('operatorName').value.trim();
            routeName = document.getElementById('routeName').value.trim();
            currentDate = document.getElementById('currentDate').value;

            if (!operatorName || !routeName) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            document.getElementById('initialScreen').style.display = 'none';
            document.getElementById('scanScreen').style.display = 'block';
            document.getElementById('displayOperator').textContent = operatorName;
            document.getElementById('displayRoute').textContent = routeName;
            document.getElementById('displayDate').textContent = currentDate;

            // Focar no input
            document.getElementById('codeInput').focus();
        }

        // Validar padrão do código
        function isValidCode(code) {
            const pattern = /^BR[0-9A-Z]+$/;
            return pattern.test(code) && code.length > 2;
        }

        // Criar som de alerta forte
        function playAlertSound() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'square';
            gainNode.gain.value = 0.3;

            oscillator.start();
            
            setTimeout(() => {
                oscillator.stop();
            }, 500);

            // Segundo beep
            setTimeout(() => {
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.frequency.value = 600;
                osc2.type = 'square';
                gain2.gain.value = 0.3;
                osc2.start();
                setTimeout(() => osc2.stop(), 500);
            }, 600);
        }

        function showAlert(message) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertOverlay').style.display = 'flex';
        }

        function closeAlert() {
            document.getElementById('alertOverlay').style.display = 'none';
            document.getElementById('codeInput').focus();
        }

        // Processar código bipado
        document.getElementById('codeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const code = this.value.trim().toUpperCase();
                
                if (!code) return;

                const time = new Date().toLocaleTimeString('pt-BR');
                const isDuplicate = scannedCodes.some(item => item.code === code);
                const isValid = isValidCode(code);

                const codeItem = {
                    code: code,
                    time: time,
                    isDuplicate: isDuplicate,
                    isValid: isValid
                };

                scannedCodes.push(codeItem);

                // Adicionar à lista de códigos válidos (sem duplicados)
                if (isValid && !isDuplicate) {
                    validCodes.add(code);
                }

                // Salvar sessão
                saveSession();

                // Adicionar à lista visual
                addCodeToList(codeItem);

                // Alertas
                if (isDuplicate) {
                    playAlertSound();
                    showAlert('CÓDIGO DUPLICADO!\n' + code);
                } else if (!isValid) {
                    playAlertSound();
                    showAlert('CÓDIGO FORA DO PADRÃO!\n' + code);
                }

                // Limpar input
                this.value = '';
            }
        });

        function addCodeToList(item) {
            const list = document.getElementById('codesList');
            const div = document.createElement('div');
            div.className = 'code-item';
            div.setAttribute('data-code', item.code);
            div.setAttribute('data-time', item.time);
            
            if (item.isDuplicate) {
                div.classList.add('duplicate');
            } else if (!item.isValid) {
                div.classList.add('invalid');
            }

            div.innerHTML = `
                <span class="code-text">${item.code}</span>
                <span class="time-text">${item.time}</span>
            `;

            list.insertBefore(div, list.firstChild);
        }

        // Função para recriar toda a lista a partir do array scannedCodes
        function refreshCodesList() {
            const list = document.getElementById('codesList');
            list.innerHTML = '';
            // Exibir em ordem reversa (mais recentes primeiro)
            scannedCodes.slice().reverse().forEach(item => addCodeToList(item));
        }

        function generateFilename(extension) {
            const date = currentDate.replace(/\//g, '-');
            return `${operatorName}_${routeName}_${date}.${extension}`;
        }

        function downloadTXT() {
            if (validCodes.size === 0 && removedCodes.length === 0) {
                alert('Nenhum dado para baixar!');
                return;
            }

            // Filtrar apenas os itens válidos e não duplicados (primeira ocorrência)
            const validItems = scannedCodes.filter(item => item.isValid && !item.isDuplicate);

            let content = `Operador: ${operatorName}\n`;
            content += `Rota: ${routeName}\n`;
            content += `Data: ${currentDate}\n`;
            
            if (validItems.length > 0) {
                content += `\n--- CÓDIGOS VÁLIDOS (com hora) ---\n\n`;
                validItems.forEach(item => {
                    content += `${item.code} - ${item.time}\n`;
                });
            }

            if (removedCodes.length > 0) {
                content += `\n--- CÓDIGOS REMOVIDOS ---\n\n`;
                removedCodes.forEach(r => {
                    content += `Código: ${r.code}\n`;
                    content += `  Bipado em: ${r.originalTime}\n`;
                    content += `  Removido em: ${r.removalTime}\n`;
                    content += `  Motivo: ${r.motivo}\n\n`;
                });
            }

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = generateFilename('txt');
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadCSV() {
            if (validCodes.size === 0 && removedCodes.length === 0) {
                alert('Nenhum dado para baixar!');
                return;
            }

            const validItems = scannedCodes.filter(item => item.isValid && !item.isDuplicate);

            let content = `Operador,Rota,Data\n`;
            content += `${operatorName},${routeName},${currentDate}\n\n`;
            
            if (validItems.length > 0) {
                content += `Código,Hora\n`;
                validItems.forEach(item => {
                    content += `${item.code},${item.time}\n`;
                });
            }

            if (removedCodes.length > 0) {
                content += `\n\n--- CÓDIGOS REMOVIDOS ---\n\n`;
                content += `Código,Hora Bipagem,Hora Remoção,Motivo\n`;
                removedCodes.forEach(r => {
                    content += `${r.code},${r.originalTime},${r.removalTime},${r.motivo}\n`;
                });
            }

            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = generateFilename('csv');
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearSession() {
            if (confirm('Tem certeza que deseja limpar todos os dados e começar uma nova sessão?')) {
                localStorage.removeItem('bipagem_session');
                location.reload();
            }
        }

        // Funções para o overlay de remoção
        function openRemoveOverlay() {
            document.getElementById('removeOverlay').style.display = 'flex';
            document.getElementById('removeCodeInput').value = '';
            document.getElementById('removeCodeInput').focus();
        }

        function closeRemoveOverlay() {
            document.getElementById('removeOverlay').style.display = 'none';
            document.getElementById('codeInput').focus();
        }

        function processRemove(motivo) {
            const codeInput = document.getElementById('removeCodeInput');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                alert('Digite ou bipe um código!');
                return;
            }

            // Encontrar todas as ocorrências do código em scannedCodes
            const indices = [];
            scannedCodes.forEach((item, index) => {
                if (item.code === code) indices.push(index);
            });

            if (indices.length === 0) {
                alert('Código não encontrado na lista!');
                codeInput.value = '';
                codeInput.focus();
                return;
            }

            const removalTime = new Date().toLocaleTimeString('pt-BR');

            // Para cada ocorrência, adicionar a removedCodes e remover de validCodes se necessário
            indices.reverse().forEach(index => {
                const removedItem = scannedCodes[index];
                
                // Adicionar ao array de removidos
                removedCodes.push({
                    code: removedItem.code,
                    originalTime: removedItem.time,
                    removalTime: removalTime,
                    motivo: motivo
                });

                // Remover de validCodes se estava lá
                if (removedItem.isValid && !removedItem.isDuplicate) {
                    validCodes.delete(removedItem.code);
                }

                // Remover do array scannedCodes
                scannedCodes.splice(index, 1);
            });

            // Salvar sessão
            saveSession();

            // Atualizar a lista visual
            refreshCodesList();

            // Fechar overlay e focar no input principal
            closeRemoveOverlay();

            // Pequeno feedback
            alert(`Código(s) ${code} removido(s) com sucesso!`);
        }

        // Manter foco no input principal
        setInterval(() => {
            if (document.getElementById('scanScreen').style.display === 'block') {
                if (document.getElementById('alertOverlay').style.display !== 'flex' && 
                    document.getElementById('removeOverlay').style.display !== 'flex') {
                    document.getElementById('codeInput').focus();
                }
            }
        }, 1000);
    </script>
</body>
</html>
